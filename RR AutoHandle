#!/bin/bash

db_connect=$(sh .asEncryptedData/getconstr.sh USR TABLE)
export ORACLE_HOME=/oracle/app/product/19c/dbhome_1
export PATH=$ORACLE_HOME/bin:$PATH
export LD_LIBRARY_PATH=$ORACLE_HOME/lib:$LD_LIBRARY_PATH
export SQLPLUS

datetime=$(date +%Y%m%d%H%M)
date_mail=$(date +%d/%m/%Y)
time_mail=$(date +%H:%M)

FILEPATH="/dir"
TO_EMAIL="email"
LOGFILE="file_${datetime}.log"
SUBJECT="RR_zero size file"

BODY="Dear all,

Please be informed that the RR file is zero-size.

Detected on: ${date_mail} at ${time_mail}

IT Application Support

Note:
-----------
The current e-mail is produced automatically by a monitoring mechanism of \$SYSTEM.
For any further clarification please communicate with Application Support Section."

SQL_QUERY="SELECT COUNT(*) FROM coll_audit WHERE WF_NAME LIKE '%RR%' AND TRUNC(timestamp_in) = TRUNC(SYSDATE) AND filesize = 0;"

# Execute SQL and capture count
COUNT=$(sqlplus -s "$db_connect" <<EOF
SET PAGESIZE 0 FEEDBACK OFF VERIFY OFF HEADING OFF ECHO OFF
$SQL_QUERY
EXIT;
EOF
)

# Trim whitespace from COUNT
COUNT=$(echo "$COUNT" | xargs)

if [[ "$COUNT" -eq 1 ]]; then
    echo "$BODY" | mail -s "$SUBJECT" "$TO_EMAIL"
    echo "[$datetime] Email sent successfully" >> "$LOGFILE"
else
    echo "[$datetime] No zero-size file detected" >> "$LOGFILE"
fi

exit 0;

